:doctype: book
:lang: en
:encoding: utf-8

//
// Document metadata
//
:author: Dualsoft
:email: help@dualsoft.com
:revnumber: 1.0-ext
:revdate: 2025-08-28
:version-label: Version
:idta-number: IDTA 02XXX-1-0-EXT
:document-status: Extension Draft
:document-type: Submodel Template Extension
:classification: Internal

//
// Table of contents configuration
//
:sectnums:
:toc: left
:toclevels: 3
:toc-title: Table of Contents

= Extended Sequence Control Submodel

[.lead]
*Status*: {document-status} +
*Version*: {revnumber} +
*Date*: {revdate} +
*Type*: {document-type} +
*Classification*: {classification} +
*Base Document*: IDTA 02XXX-1-0 Sequence Control Submodel Template

== Overview

This document extends the base Sequence Control Submodel Template with additional properties and entities for enhanced industrial automation scenarios. These extensions are implemented using the Third Party Extension mechanism without modifying the core engine.

[NOTE]
====
The extended properties in this document fall into two categories:

**Core Extensions** (실제 요구사항):
- Progress tracking entity (CustomProgress)
- Topic pairing properties (TopicIndex, IsTopicOrigin)

**Sample Extensions** (확장 예시):
- Location, Area, Duration, RetryIntervalSeconds, IsActive

The sample extensions demonstrate the extension mechanism and can be replaced with domain-specific properties as needed.
====

[IMPORTANT]
====
This document assumes familiarity with the base Sequence Control Submodel Template (SequenceControl.adoc). Only the extended properties and new concepts are documented here.
====

== Extension Mechanism

[IMPORTANT]
====
This section provides reference guidance for developers who need to implement additional extension properties beyond those defined in this document. If you are only using the extensions defined here, you can skip this section.
====

The extensions are implemented through the `ITypeFactory` interface, which allows adding new properties to existing types without modifying the core engine. The implementation uses a dual type system:

- **Runtime Types**: Business logic types (e.g., `CustomProject`, `CustomSystem`)
- **Nj Types**: JSON serialization types (e.g., `CustomNjProject`, `CustomNjSystem`)

== Extended Properties

This section describes the additional properties added to the base Sequence Control types.

=== Project Extensions

==== CustomProject

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|Location |string |0..1 |Physical or logical location of the project
|Progresses |CustomProgress[] |0..* |Collection of progress tracking entities
|===

**Semantic URLs**:
- `https://dualsoft.com/aas/extension/project/location`
- `https://dualsoft.com/aas/extension/project/progresses`

=== System Extensions

==== CustomSystem

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|Area |integer |0..1 |Area identifier or size designation
|===

**Semantic URL**:
- `https://dualsoft.com/aas/extension/system/area`

=== Flow Extensions

==== CustomFlow

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|IsActive |boolean |0..1 |Indicates whether the flow is currently active
|===

**Semantic URL**:
- `https://dualsoft.com/aas/extension/flow/isActive`

=== Work Extensions

==== CustomWork

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|Duration |double |0..1 |Expected or actual duration in seconds
|===

**Semantic URL**:
- `https://dualsoft.com/aas/extension/work/duration`

=== Call Extensions

==== CustomCall

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|RetryIntervalSeconds |double |0..1 |Interval between retry attempts in seconds
|===

**Semantic URL**:
- `https://dualsoft.com/aas/extension/call/retryIntervalSeconds`

=== ApiDef Extensions

==== CustomApiDef

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|TopicIndex |integer |0..1 |Topic index for paired API definitions (starts from 0)
|IsTopicOrigin |boolean |0..1 |Indicates if this is the origin side of a topic pair
|===

[NOTE]
====
TopicIndex and IsTopicOrigin work together to define paired API relationships:
- Both properties must be either null or non-null together
- For each TopicIndex, there must be exactly two ApiDef elements
- One with IsTopicOrigin=true (e.g., ADV - advance)
- One with IsTopicOrigin=false (e.g., RET - retract)
====

**Semantic URLs**:
- `https://dualsoft.com/aas/extension/apiDef/topicIndex`
- `https://dualsoft.com/aas/extension/apiDef/isTopicOrigin`

**Validation Rules**:
- Each TopicIndex must have exactly 2 ApiDef instances
- One instance must have IsTopicOrigin=true, the other false

== New Entities

=== CustomProgress

A new entity for tracking execution progress of systems and topics.

[cols="25%,20%,15%,40%",options="header"]
|===
|*Property* |*Type* |*Multiplicity* |*Description*
|Id |integer |0..1 |Database primary key
|SystemId |integer |0..1 |Reference to system database ID
|SystemGuid |string |1 |GUID of the associated system
|TopicIndex |integer |1 |Topic index being tracked
|Progress |integer |0..1 |Progress value (0-100)
|Description |string |0..1 |Progress description
|MaxDurationMillis |double |0..1 |Maximum expected duration in milliseconds
|===

**Semantic URLs**:
- `https://dualsoft.com/aas/extension/progress/systemGuid`
- `https://dualsoft.com/aas/extension/progress/topicIndex`
- `https://dualsoft.com/aas/extension/progress/value`
- `https://dualsoft.com/aas/extension/progress/description`
- `https://dualsoft.com/aas/extension/progress/maxDurationMillis`

== Extension Semantic URL Pattern

Extended properties follow a specific URL pattern to distinguish them from core properties:

`https://dualsoft.com/aas/extension/{type}/{property}`

Where:
- `{type}` is the lowercase type name (e.g., project, system, work)
- `{property}` is the property name in camelCase

== Database Extensions

The extension system supports automatic database schema modifications:

=== Progress Table

[source,sql]
----
CREATE TABLE progress (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    systemId INTEGER NOT NULL,
    topicIndex INTEGER NOT NULL,
    progress INTEGER,
    description TEXT,
    maxDurationMillis REAL DEFAULT 0.0,
    UNIQUE(systemId, topicIndex)
);
----

== Extended Example

Example showing a project with extended properties:

[source,json]
----
{
  "Project": {
    "Name": "Extended Assembly Line",
    "Guid": "project-ext-12345678-1234-1234-1234-123456789abc",
    "Location": "Seoul, Korea",
    "Author": "System Engineer",
    "DateTime": "2025-08-28T10:00:00Z",
    "Version": "2.1.0",
    "Progresses": [
      {
        "SystemGuid": "station1-87654321-4321-4321-4321-cba987654321",
        "TopicIndex": 0,
        "Progress": 75,
        "Description": "Cylinder operation",
        "MaxDurationMillis": 5000.0
      }
    ]
  },
  "ActiveSystems": {
    "System": [
      {
        "Name": "Station 1 Controller",
        "Guid": "station1-87654321-4321-4321-4321-cba987654321",
        "Area": 100,
        "ApiDefs": [
          {
            "Name": "Cylinder Advance",
            "Guid": "api-def-adv-11111111-2222-3333-4444",
            "IsPush": false,
            "TopicIndex": 0,
            "IsTopicOrigin": true,
            "TxGuid": "work-12121212-3434-5656-7878-909090909090",
            "RxGuid": "work-next-station-guid"
          },
          {
            "Name": "Cylinder Retract",
            "Guid": "api-def-ret-22222222-3333-4444-5555",
            "IsPush": false,
            "TopicIndex": 0,
            "IsTopicOrigin": false,
            "TxGuid": "work-12121212-3434-5656-7878-909090909090",
            "RxGuid": "work-next-station-guid"
          }
        ],
        "Flows": [
          {
            "Name": "Production Flow",
            "Guid": "flow-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
            "IsActive": true
          }
        ],
        "Works": [
          {
            "Name": "Part Processing",
            "Guid": "work-12121212-3434-5656-7878-909090909090",
            "FlowGuid": "flow-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
            "Duration": 45.5,
            "Period": 30.0,
            "Calls": [
              {
                "Name": "Start Processing",
                "Guid": "call-abcdefab-1234-5678-9012-123456789012",
                "RetryIntervalSeconds": 5.0,
                "CallType": "automatic",
                "ApiCalls": ["apicall-fedcbadc-4321-8765-2109-876543210987"],
                "Timeout": 10.0
              }
            ]
          }
        ]
      }
    ]
  }
}
----

== Implementation Guidelines

=== Type Registration

Extended types are registered through the `ExtensibleTypeFactory`:

[source,csharp]
----
// Runtime type factories
[typeof(Project)] = () => new CustomProject(),
[typeof(DsSystem)] = () => new CustomSystem(),
[typeof(Work)] = () => new CustomWork(),
[typeof(Flow)] = () => new CustomFlow(),
[typeof(Call)] = () => new CustomCall(),
[typeof(ApiDef)] = () => new CustomApiDef()

// Nj type factories (for JSON serialization)
[typeof(NjProject)] = () => new CustomNjProject(),
[typeof(NjSystem)] = () => new CustomNjSystem(),
// ... etc
----

=== Property Copying

Properties are copied between Runtime and Nj types during serialization:

[source,csharp]
----
case (CustomProject src, CustomNjProject tgt):
    tgt.Location = src.Location;
    tgt.Progresses = src.Progresses;
    break;

case (CustomSystem src, CustomNjSystem tgt):
    tgt.Area = src.Area;
    break;
// ... etc
----

=== Lifecycle Hooks

Extended types can override lifecycle methods:

- `OnConstructed()`: Called after object construction
- `OnAfterSave()`: Called after database save
- `OnAfterLoad()`: Called after database load

== Validation Rules

In addition to base validation rules, the following apply to extensions:

[cols="20%,80%",options="header"]
|===
|*Rule ID* |*Description*
|VR-EXT-001 |TopicIndex and IsTopicOrigin must both be null or both be non-null
|VR-EXT-002 |Each TopicIndex must have exactly 2 ApiDef instances
|VR-EXT-003 |For each TopicIndex, one ApiDef must have IsTopicOrigin=true and one false
|VR-EXT-004 |Progress values must be between 0 and 100 when specified
|VR-EXT-005 |SystemGuid in CustomProgress must reference an existing System
|===

== Best Practices

=== Extension Naming
- Prefix extended types with "Custom" (e.g., CustomProject, CustomSystem)
- Use descriptive property names that don't conflict with base properties
- Follow consistent naming patterns for Nj types (CustomNj{TypeName})

=== Database Compatibility
- Design extensions to work with multiple database engines (SQLite, PostgreSQL, MSSQL)
- Use nullable types appropriately for optional properties
- Handle database-specific SQL differences (e.g., IN clause variations)

=== Serialization
- Ensure all extended properties are properly serialized to JSON
- Support AASX format through semantic URLs
- Maintain backward compatibility with base types

== Summary

This extension specification adds practical enhancements to the base Sequence Control Submodel:

1. **Progress Tracking**: CustomProgress entity for monitoring execution
2. **Topic Pairing**: TopicIndex/IsTopicOrigin for paired API operations (e.g., cylinder advance/retract)
3. **Location & Area**: Physical/logical location and area information
4. **Timing Extensions**: Duration and retry interval properties
5. **State Extensions**: IsActive flag for flows

These extensions demonstrate how the Third Party Extension mechanism allows customization without modifying the core engine, maintaining compatibility while adding domain-specific functionality.

---

*Note*: This extension is specific to the HMC implementation and may serve as a reference for other third-party extensions of the Sequence Control Submodel.