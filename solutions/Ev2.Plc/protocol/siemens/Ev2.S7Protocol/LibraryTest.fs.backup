open System
open Ev2.SiemensProtocol.Core
open Ev2.SiemensProtocol.Client

/// PLC ì„¤ì • ì •ë³´
let plcConfigs = [
    { Name = "Siemens CP"
      IpAddress = "192.168.9.96"
      CpuType = CpuType.S7300
      Rack = 0
      Slot = 2
      Port = Constants.Network.DefaultPort
      LocalTSAP = Constants.TSAP.DefaultLocalTSAP
      RemoteTSAP = Constants.TSAP.getRemoteTSAP CpuType.S7300 0 2
      Timeout = TimeSpan.FromSeconds(5.0)
      MaxPDUSize = Constants.Network.DefaultPDUSize
      Password = None }
    
    { Name = "Siemens S315"
      IpAddress = "192.168.9.97"
      CpuType = CpuType.S7300
      Rack = 0
      Slot = 2
      Port = Constants.Network.DefaultPort
      LocalTSAP = Constants.TSAP.DefaultLocalTSAP
      RemoteTSAP = Constants.TSAP.getRemoteTSAP CpuType.S7300 0 2
      Timeout = TimeSpan.FromSeconds(5.0)
      MaxPDUSize = Constants.Network.DefaultPDUSize
      Password = None }
    
    { Name = "Siemens S1500"
      IpAddress = "192.168.9.99"
      CpuType = CpuType.S71500
      Rack = 0
      Slot = 0
      Port = Constants.Network.DefaultPort
      LocalTSAP = Constants.TSAP.DefaultLocalTSAP
      RemoteTSAP = Constants.TSAP.getRemoteTSAP CpuType.S71500 0 0
      Timeout = TimeSpan.FromSeconds(5.0)
      MaxPDUSize = Constants.Network.DefaultPDUSize
      Password = None }
]

/// ë‹¨ì¼ PLC í…ŒìŠ¤íŠ¸
let testPlc (config: S7Config) =
    printfn "\n========================================="
    printfn "Testing: %s" config.Name
    printfn "========================================="
    
    use client = new S7Client(config)
    
    // ì—°ê²°
    match client.Connect() with
    | Error err ->
        printfn "âŒ Connection failed: %A" err
        false
    | Ok _ ->
        printfn "âœ… Connected successfully"
        
        try
            // 1. DB1 ì½ê¸° í…ŒìŠ¤íŠ¸ (10 ë°”ì´íŠ¸)
            printfn "\nðŸ“– Reading DB1.DBB0 (10 bytes)..."
            match client.ReadDB(1, 0, 10) with
            | Ok data ->
                printfn "  Data: %s" (BitConverter.ToString(data))
            | Error err ->
                printfn "  âŒ Read failed: %A" err
            
            // 2. M ì˜ì—­ ì½ê¸° í…ŒìŠ¤íŠ¸
            printfn "\nðŸ“– Reading M0.0 (10 bytes)..."
            match client.ReadMerker(0, 10) with
            | Ok data ->
                printfn "  Data: %s" (BitConverter.ToString(data))
            | Error err ->
                printfn "  âŒ Read failed: %A" err
            
            // 3. DINT ì½ê¸° í…ŒìŠ¤íŠ¸
            printfn "\nðŸ“– Reading DB1.DBD0 (DINT)..."
            match client.ReadDInt(DataArea.DataBlock, 1, 0) with
            | Ok value ->
                printfn "  Value: %d" value
            | Error err ->
                printfn "  âŒ Read failed: %A" err
            
            // 4. REAL ì½ê¸° í…ŒìŠ¤íŠ¸
            printfn "\nðŸ“– Reading DB1.DBD4 (REAL)..."
            match client.ReadReal(DataArea.DataBlock, 1, 4) with
            | Ok value ->
                printfn "  Value: %.2f" value
            | Error err ->
                printfn "  âŒ Read failed: %A" err
            
            // 5. ë¹„íŠ¸ ì½ê¸° í…ŒìŠ¤íŠ¸
            printfn "\nðŸ“– Reading M0.0 (Bit)..."
            match client.ReadBit(DataArea.Merker, 0, 0, 0) with
            | Ok value ->
                printfn "  Value: %b" value
            | Error err ->
                printfn "  âŒ Read failed: %A" err
            
            // 6. ì“°ê¸° í…ŒìŠ¤íŠ¸ (ì„ íƒì )
            let testWrite = true  // ì•ˆì „ì„ ìœ„í•´ ê¸°ë³¸ê°’ false
            if testWrite then
                printfn "\nâœï¸ Writing test data..."
                
                // DINT ì“°ê¸°
                match client.WriteDInt(DataArea.DataBlock, 1, 100, 12345) with
                | Ok () ->
                    printfn "  âœ… Write DINT successful"
                | Error err ->
                    printfn "  âŒ Write failed: %A" err
                
                // REAL ì“°ê¸°
                match client.WriteReal(DataArea.DataBlock, 1, 104, 3.14159f) with
                | Ok () ->
                    printfn "  âœ… Write REAL successful"
                | Error err ->
                    printfn "  âŒ Write failed: %A" err
            
            // 7. ë°°ì¹˜ ì½ê¸° í…ŒìŠ¤íŠ¸
            printfn "\nðŸ“– Batch reading..."
            let requests = [|
                { Area = DataArea.DataBlock; DBNumber = 1; StartByte = 0; BitOffset = 0; Amount = 4; DataType = DInt }
                { Area = DataArea.DataBlock; DBNumber = 1; StartByte = 4; BitOffset = 0; Amount = 4; DataType = Real }
                { Area = DataArea.Merker; DBNumber = 0; StartByte = 0; BitOffset = 0; Amount = 10; DataType = Byte }
            |]
            
            match client.BatchRead(requests) with
            | Ok results ->
                printfn "  âœ… Batch read completed with %d results" results.Count
                for KeyValue(key, result) in results do
                    match result with
                    | Ok data ->
                        printfn "    %s: %s" key (BitConverter.ToString(data.[0..min 3 (data.Length-1)]))
                    | Error err ->
                        printfn "    %s: Error - %A" key err
            | Error err ->
                printfn "  âŒ Batch read failed: %A" err
            
            // í†µê³„ ì¶œë ¥
            let stats = client.GetStatistics()
            printfn "\nðŸ“Š Statistics:"
            printfn "  Packets Sent: %d" stats.PacketsSent
            printfn "  Packets Received: %d" stats.PacketsReceived
            printfn "  Success Rate: %.1f%%" stats.SuccessRate
            printfn "  Avg Response Time: %.2f ms" stats.AverageResponseTime
            printfn "  Errors: %d" stats.ErrorCount
            
            true
            
        with ex ->
            printfn "âŒ Exception: %s" ex.Message
            false

/// ëª¨ë“  PLC í…ŒìŠ¤íŠ¸
let testAllPlcs() =
    printfn "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    printfn " Siemens S7 Protocol Test Suite"
    printfn "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    printfn " Testing %d PLCs..." plcConfigs.Length
    
    let results = 
        plcConfigs
        |> List.map (fun config ->
            let success = testPlc config
            config.Name, success
        )
    
    // ê²°ê³¼ ìš”ì•½
    printfn "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    printfn " Test Results Summary"
    printfn "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    for name, success in results do
        if success then
            printfn " âœ… %s: SUCCESS" name
        else
            printfn " âŒ %s: FAILED" name
    
    let successCount = results |> List.filter snd |> List.length
    let totalCount = results.Length
    
    printfn "\n Total: %d/%d tests passed" successCount totalCount
    printfn "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

/// ê°œë³„ PLC í…ŒìŠ¤íŠ¸ (ì¸ë±ìŠ¤ë¡œ ì„ íƒ)
let testSinglePlc index =
    if index >= 0 && index < plcConfigs.Length then
        testPlc plcConfigs.[index] |> ignore
    else
        printfn "Invalid PLC index. Available: 0-%d" (plcConfigs.Length - 1)

/// ì»¤ë§¨ë“œë¼ì¸ íŒŒì‹±
let parseArgs (args: string[]) =
    if args.Length = 0 then
        None
    else
        match args.[0].ToLower() with
        | "--all" | "-a" -> Some "all"
        | "--cp" -> Some "0"
        | "--s315" -> Some "1"
        | "--s1500" -> Some "2"
        | "--help" | "-h" -> Some "help"
        | index when Int32.TryParse(index, ref 0) -> Some index
        | _ -> None

[<EntryPoint>]
let main argv =
    printfn "Siemens S7 Protocol Client v1.0"
    printfn "================================\n"
    
    match parseArgs argv with
    | Some "help" ->
        printfn "Usage:"
        printfn "  dotnet run           -- Test all PLCs"
        printfn "  dotnet run -- --all  -- Test all PLCs"
        printfn "  dotnet run -- --cp   -- Test Siemens CP (192.168.9.96)"
        printfn "  dotnet run -- --s315 -- Test Siemens S315 (192.168.9.97)"
        printfn "  dotnet run -- --s1500 -- Test Siemens S1500 (192.168.9.99)"
        printfn "  dotnet run -- 0      -- Test PLC at index 0"
        printfn "  dotnet run -- --help -- Show this help"
        0
    | Some "all" ->
        testAllPlcs()
        0
    | Some index ->
        match Int32.TryParse(index) with
        | true, idx ->
            testSinglePlc idx
            0
        | _ ->
            printfn "Invalid argument. Use --help for usage."
            1
    | None ->
        // ê¸°ë³¸: ëª¨ë“  PLC í…ŒìŠ¤íŠ¸
        testAllPlcs()
        0