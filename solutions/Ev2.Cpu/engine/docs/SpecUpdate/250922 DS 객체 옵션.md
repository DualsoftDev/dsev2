# EV2 ì—”í‹°í‹°ë³„ ì´ì¤‘ ì˜µì…˜ ì²´ê³„ ì„¤ê³„ ì‚¬ì–‘ì„œ

## ğŸ“‹ ê°œìš”

### ì„¤ê³„ ì›ì¹™
- **StaticOptions (64ë¹„íŠ¸)**: ì„¤ì •/êµ¬ì„± ì •ë³´ - ëª¨ë¸ ì •ì˜ ì‹œì ì— ê²°ì •ë˜ëŠ” ì •ì  ì†ì„±
- **DynamicOptions (64ë¹„íŠ¸)**: ìƒíƒœ/ëŸ°íƒ€ì„ ì •ë³´ - ì‹¤í–‰ ì¤‘ ë³€ê²½ë˜ëŠ” ë™ì  ì†ì„±
- ê° ì˜µì…˜ì€ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë˜ë©° DBì— ë³„ë„ BIGINT ì»¬ëŸ¼ìœ¼ë¡œ ì €ì¥

### ë¹„íŠ¸ êµ¬ì¡° (ê³µí†µ)
- **ë¹„íŠ¸ 0**: `None` (í•­ìƒ 0, ê¸°ë³¸ê°’)
- **ë¹„íŠ¸ 1-3**: `Primary Mode/State` (3ë¹„íŠ¸)
- **ë¹„íŠ¸ 4-6**: `Secondary Mode/State` (3ë¹„íŠ¸)
- **ë¹„íŠ¸ 7-9**: `Tertiary Mode/State` (3ë¹„íŠ¸)
- **ë¹„íŠ¸ 10-63**: Boolean í”Œë˜ê·¸ë“¤

---

## 1. Project Options

```fsharp
// ì •ì  ì˜µì…˜ - í”„ë¡œì íŠ¸ ì„¤ì •
type ProjectMode =
    | None = 0 
    | Test = 1 
    | Debug = 2 
    | Release = 3 
    | Reserved4 = 4
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

type ProjectEnvironment = 
    | None = 0 
    | Development = 1 
    | Production = 2 
    | Staging = 3 
    | Reserved4 = 4
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type ProjectStaticOptions =
    | None            = 0L
    | ModeMask        = 0b1110L             // ë¹„íŠ¸ 1-3: í”„ë¡œì íŠ¸ ëª¨ë“œ
    | EnvironmentMask = 0b1110000L          // ë¹„íŠ¸ 4-6: í™˜ê²½ ì„¤ì •
    | Reserved7_9     = 0b1110000000L       // ë¹„íŠ¸ 7-9: ì˜ˆì•½
    | ReadOnly        = 1L <<< 10           // ë¹„íŠ¸ 10: ì½ê¸° ì „ìš© í”„ë¡œì íŠ¸
    | AutoSave        = 1L <<< 11           // ë¹„íŠ¸ 11: ìë™ ì €ì¥ í™œì„±í™”
    | LogEnabled      = 1L <<< 12           // ë¹„íŠ¸ 12: ë¡œê¹… í™œì„±í™”
    | VersionControl  = 1L <<< 13           // ë¹„íŠ¸ 13: ë²„ì „ ê´€ë¦¬ ì‚¬ìš©
    | BackupEnabled   = 1L <<< 14           // ë¹„íŠ¸ 14: ë°±ì—… í™œì„±í™”

// ë™ì  ì˜µì…˜ - í”„ë¡œì íŠ¸ ìƒíƒœ
type ProjectState =
    | None = 0 
    | Idle = 1 
    | Running = 2 
    | Paused = 3 
    | Error = 4 
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type ProjectDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: í”„ë¡œì íŠ¸ ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | Modified        = 1L <<< 10           // ë¹„íŠ¸ 10: ìˆ˜ì •ë¨
    | Saving          = 1L <<< 11           // ë¹„íŠ¸ 11: ì €ì¥ ì¤‘
    | Loading         = 1L <<< 12           // ë¹„íŠ¸ 12: ë¡œë”© ì¤‘
    | Connected       = 1L <<< 13           // ë¹„íŠ¸ 13: ì—°ê²°ë¨
    | Synchronized    = 1L <<< 14           // ë¹„íŠ¸ 14: ë™ê¸°í™”ë¨
```

## 2. System Options

```fsharp
// ì •ì  ì˜µì…˜ - ì‹œìŠ¤í…œ ì„¤ì •
type SystemMode =
    | None = 0 
    | Simulation = 1 
    | Control = 2 
    | Monitoring = 3 
    | VirtualPlant = 4 
    | VirtualLogic = 5 
    | Reserved6 = 6
    | Reserved7 = 7

type SystemType =
    | None = 0 
    | LocalSub  = 1 //ë¶€ëª¨ì‹œìŠ¤í…œì— ì¢…ì†ëœ ë¡œì»¬ ì„œë¸Œì‹œìŠ¤í…œ
    | Reserved2 = 2 
    | Reserved3 = 3
    | Reserved4 = 4
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type SystemStaticOptions =
    | None            = 0L
    | ModeMask        = 0b1110L             // ë¹„íŠ¸ 1-3: ì‹œìŠ¤í…œ ëª¨ë“œ
    | TypeMask        = 0b1110000L          // ë¹„íŠ¸ 4-6: ì‹œìŠ¤í…œ íƒ€ì…
    | Reserved7_9     = 0b1110000000L       // ë¹„íŠ¸ 7-9: ì˜ˆì•½

// ë™ì  ì˜µì…˜ - ì‹œìŠ¤í…œ ìƒíƒœ
type SystemState =
    | None = 0 
    | Ready = 1 
    | Running = 2 
    | Error = 3 
    | Emergency = 4 
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type SystemDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: ì‹œìŠ¤í…œ ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | PauseMonitor    = 1L <<< 10           // ë¹„íŠ¸ 10: Pause ëª¨ë‹ˆí„°ë§ ê°’
    | IdleMonitor     = 1L <<< 11           // ë¹„íŠ¸ 11: Idle ëª¨ë‹ˆí„°ë§ ê°’
    | AutoMonitor     = 1L <<< 12           // ë¹„íŠ¸ 12: Auto ëª¨ë‹ˆí„°ë§ ê°’
    | ManualMonitor   = 1L <<< 13           // ë¹„íŠ¸ 13: Manual ëª¨ë‹ˆí„°ë§ ê°’
    | DriveMonitor    = 1L <<< 14           // ë¹„íŠ¸ 14: Drive ëª¨ë‹ˆí„°ë§ ê°’
    | TestMonitor     = 1L <<< 15           // ë¹„íŠ¸ 15: Test ëª¨ë‹ˆí„°ë§ ê°’
    | ErrorMonitor    = 1L <<< 16           // ë¹„íŠ¸ 16: Error ëª¨ë‹ˆí„°ë§ ê°’
    | EmergencyMonitor= 1L <<< 17           // ë¹„íŠ¸ 17: Emergency ëª¨ë‹ˆí„°ë§ ê°’
    | ReadyMonitor    = 1L <<< 18           // ë¹„íŠ¸ 18: Ready ëª¨ë‹ˆí„°ë§ ê°’
    | OriginMonitor   = 1L <<< 19           // ë¹„íŠ¸ 19: Origin ëª¨ë‹ˆí„°ë§ ê°’
    | GoingMonitor    = 1L <<< 20           // ë¹„íŠ¸ 20: Going ëª¨ë‹ˆí„°ë§ ê°’
```

## 3. Flow Options

```fsharp
// ì •ì  ì˜µì…˜ - Flow ì„¤ì •
[<System.Flags>]
type FlowStaticOptions =
    | None            = 0L
    | Reserved1_9     = 0b1111111110L       // ë¹„íŠ¸ 1-9: ì˜ˆì•½

// ë™ì  ì˜µì…˜ - Flow ìƒíƒœ
type FlowState =
    | None = 0 
    | Idle = 1 
    | Auto = 2 
    | Manual = 3 
    | Reserved4 = 4 
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type FlowDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: Flow ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | DriveState      = 1L <<< 10           // ë¹„íŠ¸ 10: Drive ìƒíƒœ
    | TestState       = 1L <<< 11           // ë¹„íŠ¸ 11: Test ìƒíƒœ
    | ErrorState      = 1L <<< 12           // ë¹„íŠ¸ 12: Error ìƒíƒœ
    | EmergencyState  = 1L <<< 13           // ë¹„íŠ¸ 13: Emergency ìƒíƒœ
    | ReadyState      = 1L <<< 14           // ë¹„íŠ¸ 14: Ready ìƒíƒœ
    | OriginState     = 1L <<< 15           // ë¹„íŠ¸ 15: Origin ìƒíƒœ
    | GoingState      = 1L <<< 16           // ë¹„íŠ¸ 16: Going ìƒíƒœ
    | PauseState      = 1L <<< 17           // ë¹„íŠ¸ 17: Pause ìƒíƒœ
```

## 4. Work Options

    ì‚­ì œí›„  WorkOptions.IsFinished ì¶”ê°€

    member val IsFinished   = false      with get, set  
   
    ì‚­ì œí›„ WorkDynamicOptions.StateMask ì¶”ê°€

    member val Status4 = Option<DbStatus4>.None with get, set

```fsharp
// ì •ì  ì˜µì…˜ - Work ì„¤ì •

[<System.Flags>]
type WorkStaticOptions =
    | None            = 0L
    | Reserved1_9     = 0b1111111110L       // ë¹„íŠ¸ 1-9: ì˜ˆì•½
    | IsFinished      = 1L <<< 10           // ë¹„íŠ¸ 10: ì™„ë£Œë¨

// ë™ì  ì˜µì…˜ - Work ìƒíƒœ
type WorkState =
    | None = 0 
    | Ready = 1 
    | Going = 2 
    | Finish = 3 
    | Homing = 4 
    | Reserved5 = 5 
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type WorkDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: Work ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | IsError         = 1L <<< 10           // ë¹„íŠ¸ 10: ì—ëŸ¬ ìƒíƒœ
```

## 5. Call Options
    Call member ë³„ë„ì¶”ê°€ í•„ìš”

    member val ActionHoldTimeMs = actionHoldTimeMs   with get, set

    member val SensorDelayTimeMs = sensorDelayTimeMs   with get, set
    
    ì‚­ì œí›„ CallDynamicOptions.StateMask ì¶”ê°€

    member val Status4 = Option<DbStatus4>.None with get, set

```fsharp
// ì •ì  ì˜µì…˜ - Call ì„¤ì •
type CallActionType =
    | Normal = 0 
    | Push = 1 
    | Pulse = 2 
    | HoldTime = 3 
    | Toggle = 4 
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type CallStaticOptions =
    | None            = 0L
    | ActionTypeMask  = 0b1110L             // ë¹„íŠ¸ 1-3: Action íƒ€ì…
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | Disabled        = 1L <<< 10           // ë¹„íŠ¸ 10: ë¹„í™œì„±í™”
    | SkipOrigin      = 1L <<< 11           // ë¹„íŠ¸ 11: Origin ìŠ¤í‚µ

// ë™ì  ì˜µì…˜ - Call ìƒíƒœ
type CallState =
    | None = 0 
    | Ready = 1 
    | Going = 2 
    | Finish = 3 
    | Homing = 4 
    | Reserved5 = 5 
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type CallDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: Call ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | IsTimeout       = 1L <<< 10           // ë¹„íŠ¸ 10: íƒ€ì„ì•„ì›ƒ
    | IsSensorError   = 1L <<< 11           // ë¹„íŠ¸ 11: ì„¼ì„œì—ëŸ¬
```

## 6. ApiCall Options


    ApiCall member ë³„ë„ì¶”ê°€ í•„ìš” (ev2 ì‹ ê·œê¸°ëŠ¥ optionê³¼ ë¬´ê´€)
    
    member val OptionStart = nullString   with get, set


```fsharp
// ì •ì  ì˜µì…˜ - ApiCall ì„¤ì •
[<System.Flags>]
type ApiCallStaticOptions =
    | None            = 0L
    | Reserved1_9     = 0b1111111110L       // ë¹„íŠ¸ 1-9: ì˜ˆì•½

// ë™ì  ì˜µì…˜ - ApiCall ìƒíƒœ
type ApiCallState =
    | None = 0 
    | Pending = 1 
    | Processing = 2 
    | Success = 3 
    | Failed = 4 
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type ApiCallDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: ApiCall ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | IsExecuting     = 1L <<< 10           // ë¹„íŠ¸ 10: ì‹¤í–‰ ì¤‘
    | IsTimeout       = 1L <<< 11           // ë¹„íŠ¸ 11: íƒ€ì„ì•„ì›ƒ ë°œìƒ
    | IsSensorError   = 1L <<< 12           // ë¹„íŠ¸ 12: ì„¼ì„œì—ëŸ¬
```

## 7. ApiDef Options

```fsharp
// ì •ì  ì˜µì…˜ - ApiDef ì„¤ì •
type ApiDefMode =
    | Normal = 0 
    | ResetApi = 1 
    | ApiOffReset = 2 
    | Reserved3 = 3
    | Reserved4 = 4
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type ApiDefStaticOptions =
    | None            = 0L
    | ModeMask        = 0b1110L             // ë¹„íŠ¸ 1-3: ApiDef ëª¨ë“œ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½

// ë™ì  ì˜µì…˜ - ApiDef ìƒíƒœ
type ApiDefState =
    | None = 0 
    | Available = 1 
    | Unavailable = 2 
    | Maintenance = 3 
    | Reserved4 = 4
    | Reserved5 = 5
    | Reserved6 = 6
    | Reserved7 = 7

[<System.Flags>]
type ApiDefDynamicOptions =
    | None            = 0L
    | StateMask       = 0b1110L             // ë¹„íŠ¸ 1-3: ApiDef ìƒíƒœ
    | Reserved4_9     = 0b1111110000L       // ë¹„íŠ¸ 4-9: ì˜ˆì•½
    | IsOnline        = 1L <<< 10           // ë¹„íŠ¸ 10: ì˜¨ë¼ì¸
    | IsHealthy       = 1L <<< 11           // ë¹„íŠ¸ 11: ì •ìƒ
```

## ê³µí†µ í—¬í¼ ëª¨ë“ˆ

```fsharp
module OptionsHelper =
    // í”Œë˜ê·¸ ê²€ì‚¬
    let hasFlag options flag = (options &&& flag) = flag
    
    // í”Œë˜ê·¸ ì„¤ì •
    let setFlag options flag value = 
        if value then options ||| flag else options &&& ~~~flag
    
    // ëª¨ë“œ/ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    let getMode options mask =
        let shift = System.Numerics.BitOperations.TrailingZeroCount(uint64 mask)
        int ((options &&& mask) >>> shift)
    
    // ëª¨ë“œ/ìƒíƒœ ì„¤ì •
    let setMode options mask mode =
        let shift = System.Numerics.BitOperations.TrailingZeroCount(uint64 mask)
        (options &&& ~~~mask) ||| (int64 mode <<< shift)
    
    // ì—¬ëŸ¬ í”Œë˜ê·¸ í•œë²ˆì— ì„¤ì •
    let setMultipleFlags options flags values =
        List.fold2 (fun opts flag value -> setFlag opts flag value) 
                   options flags values
    
    // ì˜µì…˜ ì´ˆê¸°í™”
    let clearOptions options mask = options &&& ~~~mask
    
    // ì˜µì…˜ ë³‘í•©
    let mergeOptions base overlay mask = 
        (base &&& ~~~mask) ||| (overlay &&& mask)
```

## DB ìŠ¤í‚¤ë§ˆ ì˜ˆì œ

```sql
-- Project í…Œì´ë¸”
CREATE TABLE Project (
    Id BIGINT PRIMARY KEY,
    Name NVARCHAR(255),
    StaticOptions BIGINT NOT NULL DEFAULT 0,  -- ì •ì  ì„¤ì •
    DynamicOptions BIGINT NOT NULL DEFAULT 0, -- ë™ì  ìƒíƒœ
    CreatedAt DATETIME,
    UpdatedAt DATETIME
);

-- System í…Œì´ë¸”
CREATE TABLE System (
    Id BIGINT PRIMARY KEY,
    ProjectId BIGINT,
    Name NVARCHAR(255),
    StaticOptions BIGINT NOT NULL DEFAULT 0,  -- ì •ì  ì„¤ì •
    DynamicOptions BIGINT NOT NULL DEFAULT 0, -- ë™ì  ìƒíƒœ
    FOREIGN KEY (ProjectId) REFERENCES Project(Id)
);

-- ì¸ë±ìŠ¤ ì¶”ê°€ (ì˜µì…˜ ê¸°ë°˜ ê²€ìƒ‰ìš©)
CREATE INDEX IX_Project_StaticOptions ON Project(StaticOptions);
CREATE INDEX IX_Project_DynamicOptions ON Project(DynamicOptions);
CREATE INDEX IX_System_StaticOptions ON System(StaticOptions);
CREATE INDEX IX_System_DynamicOptions ON System(DynamicOptions);
```

## ì‚¬ìš© ì˜ˆì œ

```fsharp
// ì •ì  ì˜µì…˜ ì„¤ì • (ëª¨ë¸ ì •ì˜ ì‹œ)
let projectStatic = 
    ProjectStaticOptions.None
    |> OptionsHelper.setMode ProjectStaticOptions.ModeMask (int ProjectMode.Debug)
    |> OptionsHelper.setFlag ProjectStaticOptions.AutoSave true
    |> OptionsHelper.setFlag ProjectStaticOptions.LogEnabled true

// ë™ì  ì˜µì…˜ ì—…ë°ì´íŠ¸ (ëŸ°íƒ€ì„)
let updateProjectState state options =
    options 
    |> OptionsHelper.setMode ProjectDynamicOptions.StateMask (int state)
    |> OptionsHelper.setFlag ProjectDynamicOptions.Modified true

// ìƒíƒœ í™•ì¸
let isProjectRunning options =
    OptionsHelper.getMode options ProjectDynamicOptions.StateMask = int ProjectState.Running

// DB ì¿¼ë¦¬ ì˜ˆì œ
let getRunningProjects() =
    query {
        for p in db.Projects do
        where ((p.DynamicOptions &&& 0b1110L) = int64 ProjectState.Running)
        select p
    }
```

## ì£¼ìš” íŠ¹ì§•

### ì¥ì 
1. **ëª…í™•í•œ ë¶„ë¦¬**: ì •ì  ì„¤ì •ê³¼ ë™ì  ìƒíƒœì˜ ëª…í™•í•œ êµ¬ë¶„
2. **ì„±ëŠ¥ ìµœì í™”**: ìì£¼ ë³€ê²½ë˜ëŠ” ë™ì  ì˜µì…˜ë§Œ ì—…ë°ì´íŠ¸
3. **ìºì‹± íš¨ìœ¨**: ì •ì  ì˜µì…˜ì€ ìºì‹± ê°€ëŠ¥
4. **ë™ì‹œì„± ê°œì„ **: ì •ì /ë™ì  ì˜µì…˜ ë…ë¦½ì  ì—…ë°ì´íŠ¸ë¡œ Lock ê²½í•© ê°ì†Œ
5. **ê°ì‚¬ ì¶”ì **: ì„¤ì • ë³€ê²½ê³¼ ìƒíƒœ ë³€ê²½ì„ ë³„ë„ë¡œ ì¶”ì  ê°€ëŠ¥
6. **í™•ì¥ì„±**: ê°ê° 64ë¹„íŠ¸ë¡œ ì´ 128ë¹„íŠ¸ í™œìš© ê°€ëŠ¥

### DB ê³ ë ¤ì‚¬í•­
- ì •ì  ì˜µì…˜: ìì£¼ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¸ë±ì‹±ì— ì í•©
- ë™ì  ì˜µì…˜: ìì£¼ ë³€ê²½ë˜ë¯€ë¡œ ì„ íƒì  ì¸ë±ì‹±
- íŒŒí‹°ì…”ë‹ ì „ëµ: ë™ì  ì˜µì…˜ ê¸°ë°˜ íŒŒí‹°ì…”ë‹ ê°€ëŠ¥
- íŠ¸ë¦¬ê±°/ì´ë²¤íŠ¸: íŠ¹ì • ìƒíƒœ ë³€ê²½ ì‹œ íŠ¸ë¦¬ê±° ì‹¤í–‰ ê°€ëŠ¥